<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Collaboration Test</title>
    <link rel="stylesheet" href="/css/websocket-collaboration.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }
        .test-section h3 {
            color: #333;
            margin-top: 0;
        }
        .test-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .test-button {
            background: #007cba;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #005a87;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b8daff;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>WebSocket Collaboration System Test</h1>
        
        <!-- Hidden data for WebSocket client -->
        <div style="display: none;">
            <div data-workspace-id="demo-workspace-456"></div>
            <div data-auth-token="2|iT0DSxrTDxhrw6YfOoAp0KRzFc1q9MGXpLocVFQdc9775ef2"></div>
            <div data-current-user='{"id": 2, "name": "Demo User", "email": "demo@websocket.com"}'></div>
        </div>
        
        <div class="test-section">
            <h3>üîå Connection Status</h3>
            <div id="connection-status" class="status info">Testing connection...</div>
            <button class="test-button" onclick="testConnection()">Test Connection</button>
        </div>
        
        <div class="test-section">
            <h3>üë• Workspace Management</h3>
            <button class="test-button" onclick="joinWorkspace()">Join Workspace</button>
            <button class="test-button" onclick="leaveWorkspace()">Leave Workspace</button>
            <div id="workspace-status" class="status info">Ready to test</div>
        </div>
        
        <div class="test-section">
            <h3>üñ±Ô∏è Cursor Tracking</h3>
            <p>Move your cursor around this area to test real-time tracking:</p>
            <div id="cursor-test-area" style="background: #f0f0f0; height: 200px; border: 2px dashed #ccc; position: relative; cursor: crosshair;">
                <p style="text-align: center; margin-top: 80px;">Move your cursor here</p>
            </div>
            <div id="cursor-status" class="status info">Cursor tracking ready</div>
        </div>
        
        <div class="test-section">
            <h3>üìù Document Collaboration</h3>
            <input type="text" class="test-input" data-document-id="demo-text-input" placeholder="Type here to test real-time collaboration...">
            <textarea class="test-input" data-document-id="demo-textarea" rows="4" placeholder="Type in this textarea to test document sync..."></textarea>
            <div id="document-status" class="status info">Document sync ready</div>
        </div>
        
        <div class="test-section">
            <h3>üîî Notifications</h3>
            <button class="test-button" onclick="sendTestNotification()">Send Test Notification</button>
            <button class="test-button" onclick="sendInfoNotification()">Send Info</button>
            <button class="test-button" onclick="sendWarningNotification()">Send Warning</button>
            <div id="notification-status" class="status info">Notifications ready</div>
        </div>
        
        <div class="test-section">
            <h3>üëØ Collaboration Sessions</h3>
            <button class="test-button" onclick="startSession()">Start Session</button>
            <button class="test-button" onclick="endSession()">End Session</button>
            <div id="session-status" class="status info">Session management ready</div>
        </div>
        
        <div class="test-section">
            <h3>üìä Test Results</h3>
            <div id="test-results"></div>
        </div>
    </div>

    <!-- WebSocket Scripts -->
    <script src="/js/websocket-client.js"></script>
    
    <script>
        // Test WebSocket functionality
        let wsClient = null;
        let testResults = [];
        
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }
        
        function addTestResult(test, success, message) {
            testResults.push({
                test: test,
                success: success,
                message: message,
                timestamp: new Date().toLocaleTimeString()
            });
            updateTestResults();
        }
        
        function updateTestResults() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '';
            
            testResults.forEach(result => {
                const resultDiv = document.createElement('div');
                resultDiv.className = `status ${result.success ? 'success' : 'error'}`;
                resultDiv.innerHTML = `
                    <strong>[${result.timestamp}]</strong> ${result.test}: ${result.message}
                `;
                resultsDiv.appendChild(resultDiv);
            });
        }
        
        async function testConnection() {
            updateStatus('connection-status', 'Testing connection...', 'info');
            
            try {
                // Test basic API connection
                const response = await fetch('/api/health');
                const data = await response.json();
                
                if (data.success) {
                    updateStatus('connection-status', 'API connection successful', 'success');
                    addTestResult('API Connection', true, 'Health check passed');
                    
                    // Initialize WebSocket client
                    wsClient = new WebSocketClient({
                        baseUrl: 'ws://localhost:6001',
                        authToken: '2|iT0DSxrTDxhrw6YfOoAp0KRzFc1q9MGXpLocVFQdc9775ef2',
                        workspaceId: 'demo-workspace-456',
                        userId: 2,
                        userName: 'Demo User'
                    });
                    
                    addTestResult('WebSocket Client', true, 'WebSocket client initialized');
                } else {
                    updateStatus('connection-status', 'API connection failed', 'error');
                    addTestResult('API Connection', false, 'Health check failed');
                }
            } catch (error) {
                updateStatus('connection-status', 'Connection error: ' + error.message, 'error');
                addTestResult('API Connection', false, 'Connection error: ' + error.message);
            }
        }
        
        async function joinWorkspace() {
            if (!wsClient) {
                updateStatus('workspace-status', 'Please test connection first', 'error');
                return;
            }
            
            updateStatus('workspace-status', 'Joining workspace...', 'info');
            
            try {
                const result = await wsClient.joinWorkspace('demo-workspace-456');
                updateStatus('workspace-status', `Joined workspace with ${result.current_users.length} users`, 'success');
                addTestResult('Join Workspace', true, 'Successfully joined workspace');
            } catch (error) {
                updateStatus('workspace-status', 'Failed to join workspace: ' + error.message, 'error');
                addTestResult('Join Workspace', false, 'Failed to join workspace: ' + error.message);
            }
        }
        
        async function leaveWorkspace() {
            if (!wsClient) {
                updateStatus('workspace-status', 'Please test connection first', 'error');
                return;
            }
            
            updateStatus('workspace-status', 'Leaving workspace...', 'info');
            
            try {
                await wsClient.leaveWorkspace();
                updateStatus('workspace-status', 'Left workspace successfully', 'success');
                addTestResult('Leave Workspace', true, 'Successfully left workspace');
            } catch (error) {
                updateStatus('workspace-status', 'Failed to leave workspace: ' + error.message, 'error');
                addTestResult('Leave Workspace', false, 'Failed to leave workspace: ' + error.message);
            }
        }
        
        async function sendTestNotification() {
            if (!wsClient) {
                updateStatus('notification-status', 'Please test connection first', 'error');
                return;
            }
            
            try {
                await wsClient.sendNotification('success', 'Test notification sent successfully!', {
                    test: true,
                    timestamp: new Date().toISOString()
                });
                updateStatus('notification-status', 'Test notification sent', 'success');
                addTestResult('Send Notification', true, 'Test notification sent successfully');
            } catch (error) {
                updateStatus('notification-status', 'Failed to send notification: ' + error.message, 'error');
                addTestResult('Send Notification', false, 'Failed to send notification: ' + error.message);
            }
        }
        
        async function sendInfoNotification() {
            if (!wsClient) return;
            
            try {
                await wsClient.sendNotification('info', 'This is an info notification', {type: 'info'});
                addTestResult('Info Notification', true, 'Info notification sent');
            } catch (error) {
                addTestResult('Info Notification', false, 'Failed to send info notification');
            }
        }
        
        async function sendWarningNotification() {
            if (!wsClient) return;
            
            try {
                await wsClient.sendNotification('warning', 'This is a warning notification', {type: 'warning'});
                addTestResult('Warning Notification', true, 'Warning notification sent');
            } catch (error) {
                addTestResult('Warning Notification', false, 'Failed to send warning notification');
            }
        }
        
        async function startSession() {
            if (!wsClient) {
                updateStatus('session-status', 'Please test connection first', 'error');
                return;
            }
            
            updateStatus('session-status', 'Starting session...', 'info');
            
            try {
                const response = await fetch('/api/websocket/start-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer 2|iT0DSxrTDxhrw6YfOoAp0KRzFc1q9MGXpLocVFQdc9775ef2'
                    },
                    body: JSON.stringify({
                        workspace_id: 'demo-workspace-456',
                        session_type: 'demo_session',
                        session_data: {
                            page: '/websocket-test',
                            title: 'WebSocket Demo Session'
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateStatus('session-status', `Session started: ${result.data.id}`, 'success');
                    addTestResult('Start Session', true, 'Collaboration session started successfully');
                    window.currentSessionId = result.data.id;
                } else {
                    updateStatus('session-status', 'Failed to start session', 'error');
                    addTestResult('Start Session', false, 'Failed to start session');
                }
            } catch (error) {
                updateStatus('session-status', 'Error starting session: ' + error.message, 'error');
                addTestResult('Start Session', false, 'Error starting session: ' + error.message);
            }
        }
        
        async function endSession() {
            if (!wsClient || !window.currentSessionId) {
                updateStatus('session-status', 'No active session to end', 'error');
                return;
            }
            
            updateStatus('session-status', 'Ending session...', 'info');
            
            try {
                const response = await fetch('/api/websocket/end-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer 2|iT0DSxrTDxhrw6YfOoAp0KRzFc1q9MGXpLocVFQdc9775ef2'
                    },
                    body: JSON.stringify({
                        workspace_id: 'demo-workspace-456',
                        session_id: window.currentSessionId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateStatus('session-status', 'Session ended successfully', 'success');
                    addTestResult('End Session', true, 'Collaboration session ended successfully');
                    window.currentSessionId = null;
                } else {
                    updateStatus('session-status', 'Failed to end session', 'error');
                    addTestResult('End Session', false, 'Failed to end session');
                }
            } catch (error) {
                updateStatus('session-status', 'Error ending session: ' + error.message, 'error');
                addTestResult('End Session', false, 'Error ending session: ' + error.message);
            }
        }
        
        // Track cursor movement in test area
        document.getElementById('cursor-test-area').addEventListener('mousemove', async (e) => {
            if (!wsClient) return;
            
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            try {
                await fetch('/api/websocket/update-cursor', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer 2|iT0DSxrTDxhrw6YfOoAp0KRzFc1q9MGXpLocVFQdc9775ef2'
                    },
                    body: JSON.stringify({
                        workspace_id: 'demo-workspace-456',
                        cursor_position: { x, y },
                        page_url: '/websocket-test'
                    })
                });
                
                updateStatus('cursor-status', `Cursor tracked: (${Math.round(x)}, ${Math.round(y)})`, 'success');
            } catch (error) {
                updateStatus('cursor-status', 'Cursor tracking error: ' + error.message, 'error');
            }
        });
        
        // Track document changes
        document.querySelectorAll('[data-document-id]').forEach(element => {
            element.addEventListener('input', async (e) => {
                if (!wsClient) return;
                
                const documentId = e.target.dataset.documentId;
                const content = e.target.value;
                
                try {
                    await fetch('/api/websocket/update-document', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer 2|iT0DSxrTDxhrw6YfOoAp0KRzFc1q9MGXpLocVFQdc9775ef2'
                        },
                        body: JSON.stringify({
                            workspace_id: 'demo-workspace-456',
                            document_id: documentId,
                            changes: {
                                operation: 'update',
                                content: content,
                                timestamp: new Date().toISOString()
                            },
                            document_type: 'text'
                        })
                    });
                    
                    updateStatus('document-status', `Document ${documentId} updated`, 'success');
                } catch (error) {
                    updateStatus('document-status', 'Document sync error: ' + error.message, 'error');
                }
            });
        });
        
        // Auto-initialize
        document.addEventListener('DOMContentLoaded', function() {
            addTestResult('Page Load', true, 'WebSocket test page loaded successfully');
        });
    </script>
</body>
</html>